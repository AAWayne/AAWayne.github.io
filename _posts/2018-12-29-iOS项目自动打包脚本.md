---
layout:     post
title:      iOSé¡¹ç›®è‡ªåŠ¨æ‰“åŒ…è„šæœ¬
subtitle:   
date:       2018-12-29
author:     é˜¿å”¯ä¸çŸ¥é“
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - iOS
    - shellè„šæœ¬
---


### è‡ªåŠ¨åŠŸèƒ½æ‰“åŒ…å±•ç¤ºï¼š
![æ‰“åŒ…æ¼”ç¤º.png](https://upload-images.jianshu.io/upload_images/2822163-90ac29e69da07fc8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### å¹³æ—¶è‡ªç”¨æ‰“åŒ…è„šæœ¬ï¼Œæ”¯æŒè‡ªåŠ¨ä¸Šä¼ è’²å…¬è‹±ã€App Store
### è¿™é‡Œå…·ä½“å‚è€ƒçš„æ˜¯
[1ã€è¯¦è§£Shellè„šæœ¬å®ç°iOSè‡ªåŠ¨åŒ–ç¼–è¯‘æ‰“åŒ…æäº¤](http://www.jianshu.com/p/bd4c22952e01)
[2ã€iOSè‡ªåŠ¨åŒ–æ‰“åŒ…è„šæœ¬(shell)](https://blog.csdn.net/u010458808/article/details/68942917)
#### æ‰“åŒ…å‡†å¤‡å·¥ä½œï¼ˆ1ä¸ªè‡ªåŠ¨æ‰“åŒ…è„šæœ¬æ–‡ä»¶ã€1ä¸ªplistæ–‡ä»¶ï¼‰
##### Githubåœ°å€ï¼šhttps://github.com/90candy/AutoPackage
#### ä½¿ç”¨æ–¹æ³•ï¼š[ç‚¹å‡»ä¸‹è½½è„šæœ¬ç›¸å…³æ–‡ä»¶](https://codeload.github.com/90candy/AutoPackage/zip/master)
1ã€å°†`AutoPackage.sh` è„šæœ¬å’Œ`autoplistæ–‡ä»¶å¤¹`æ‹–å…¥`é¡¹ç›®æ ¹ç›®å½•`å

2ã€é…ç½®æ‰“å¼€ç¼–è¾‘`AutoPackage.sh`ä¸­çš„é…ç½®å‚æ•°ï¼ˆè‹¥åªæ‰“åŒ…ï¼Œåˆ™åªéœ€é…ç½®`pro_full_name`å³å¯ï¼‰

3ã€å†å°†`AutoPackage.sh`è„šæœ¬æ–‡ä»¶æ‹–å…¥`ç»ˆç«¯`å›è½¦å³å¯æ‰§è¡Œè‡ªåŠ¨æ‰“åŒ…è„šæœ¬

4ã€æ‰§è¡ŒåæŒ‰éœ€æ±‚é€‰æ‹©æ‰“åŒ…ç‰ˆæœ¬ï¼ˆä¼ä¸šç‰ˆã€æ­£å¼ç‰ˆã€æµ‹è¯•ç‰ˆã€å¼€å‘ç‰ˆï¼‰

5ã€å¦‚æœæ‰§è¡Œè„šæœ¬æ—¶å‡ºç°å¦‚ä¸‹é”™è¯¯æ˜¯å› ä¸ºæ–‡ä»¶æƒé™ä¸è¶³ï¼Œåªéœ€å¯¹å…¶æˆæƒ777å³å¯

```
-bash: /Users/candy/Desktop/AutoPackage.sh: Permission denied
```
æ‰§è¡Œå¦‚ä¸‹æˆæƒå‘½ä»¤å³å¯ï¼ˆè¿™é‡Œçš„`/Users/candy/Desktop/AutoPackage.sh`è·¯å¾„å‚è€ƒä¸Šé¢çš„ï¼‰

```
chmod -R 777 /Users/candy/Desktop/AutoPackage.sh
```
### æ‰“åŒ…è„šæœ¬æ ¸å¿ƒå†…å®¹å±•ç¤º

```
# å¼€å§‹æ‰“åŒ…æ“ä½œ
# å¼€å§‹æ—¶é—´ï¼ˆç”¨äºè®¡ç®—æ‰“åŒ…è„šæœ¬æ‰§è¡Œæ—¶é—´ï¼‰
begin_time=$(date +%s)
# è·å–ç³»ç»Ÿæ—¶é—´
date_string=`date +"%Y-%m-%d_%H-%M-%S"`
# è·å–è„šæœ¬å½“å‰æ‰€åœ¨ç›®å½•(å³ä¸Šçº§ç›®å½•ç»å¯¹è·¯å¾„)
root_dir=$(cd "$(dirname "$0")"; pwd)/
# åˆ‡æ¢åˆ°å½“å‰è„šæœ¬çš„å·¥ä½œç›®å½•
cd ${root_dir}
# è·å–å½“å‰ç›®å½•åç§°ï¼ˆçˆ¶æ–‡ä»¶å¤¹åå­—ï¼‰
d_filename=${PWD##*/} # æ‰“å°å½“å‰æ‰€åœ¨ç›®å½•(basename `pwd`) æˆ– echo ${d_filename}
# æ—¶é—´è½¬æ¢å‡½æ•°ï¼ˆç§’è½¬åˆ†é’Ÿï¼‰
timeTransformation()
{
    if [ $1 -le 0 ]; then
    echo "============ ğŸ˜­è¯·æ£€æŸ¥é¡¹ç›®æ˜¯å¦èƒ½æ­£å¸¸æ‰‹åŠ¨æ‰“åŒ…å¹¶å¯¼å‡ºipaæ–‡ä»¶ ======="
    exit
    fi
    if [ $1 -gt 59 ]; then
    t_min=$[$1 / 60]
    t_second=$[$1 % 60]
    echo "============ æœ¬æ¬¡$2ç”¨æ—¶ï¼š${t_min}åˆ†${t_second}ç§’ ======="
    else
    echo "============ æœ¬æ¬¡$2ç”¨æ—¶ï¼š$1ç§’ ======="
    fi
}
echo "============ ${d_filename} æ‰“åŒ…å¼€å§‹ ======="
# é»˜è®¤Releaseç‰ˆ
pro_environ=Release
# å¦‚æœæ²¡æœ‰ä½¿ç”¨cocoapods åä¹‹ifä¼šå¤„ç†
pro_clean=project
if [ $pro_suffix == xcworkspace ]; then
pro_clean=workspace
fi

# Cleanæ“ä½œ
xcodebuild clean -${pro_clean} ${pro_name}.${pro_suffix} -scheme ${pro_name} -configuration ${pro_environ}
judgementLastIsSuccsess $? "Clean"
# åˆ›å»ºå­˜æ”¾ archiveå’ŒIPA çš„æ–‡ä»¶å¤¹
cd ../
ipa_dir=${d_filename}_${date_string}
mkdir ${ipa_dir}
cd ./${d_filename}
# Archive
xcodebuild archive -${pro_clean} ${pro_name}.${pro_suffix} -scheme ${pro_name} -archivePath ../${ipa_dir}/${pro_name}.xcarchive
judgementLastIsSuccsess $? "Archive"
cd ../
# å¯¼å‡ºIPAåŒ…
xcodebuild -exportArchive -archivePath ./${ipa_dir}/${pro_name}.xcarchive -exportOptionsPlist ./${d_filename}/autoplist/${pro_plist}.plist -exportPath ./${ipa_dir}
judgementLastIsSuccsess $? "å¯¼å‡ºIPAåŒ…"
# åˆ‡æ¢åˆ°ipaç›®å½•å»åˆ é™¤${pro_name}.xcarchiveåŒ…
cd ./${ipa_dir}
rm -r ${pro_name}.xcarchive
# ipaæ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºä¸Šä¼ ï¼‰
ipa_path="./${pro_name}.ipa"
echo "============ ${d_filename} æ‰“åŒ…å®Œæˆ ======="
# æ‰“åŒ…ç»“æŸæ—¶é—´
end_time=$(date +%s)
# è®¡ç®—æ‰“åŒ…æ—¶é—´(ç§’ï¼šs)
cost_time=$[$end_time - $begin_time]
#è°ƒç”¨æ—¶é—´è½¬æ¢å‡½æ•°
timeTransformation $cost_time "æ‰“åŒ…"


########################## ä¸Šä¼ è’²å…¬è‹± #################################
uploadPGY()
{
    # åˆ¤æ–­é…ç½®æ˜¯å¦ä¸ºç©ºï¼Œç©ºåˆ™ä»£è¡¨ä¸ä¸Šä¼ 
    if [ -z "$api_key" ] || [ -z "$ukey" ]; then
    echo "============ è¯·å…ˆé…ç½®è’²å…¬è‹±çš„ api_key & ukey ======="
    return
    fi
    # ä¸Šä¼ å¼€å§‹æ—¶é—´
    upload_start_time=$(date +%s)
    # å¼€å§‹ä¸Šä¼ 
    echo "============ æ­£åœ¨ä¸Šä¼  ${d_filename} åˆ° è’²å…¬è‹± ======="
    curl -F "file=@${ipa_path}" -F "uKey=${ukey}" -F "_api_key=${api_key}" https://qiniu-storage.pgyer.com/apiv1/app/upload
    judgementLastIsSuccsess $? "ä¸Šä¼ è’²å…¬è‹±"
    echo "============ ä¸Šä¼ ç»“æŸ ======="
    # ä¸Šä¼ ç»“æŸæ—¶é—´
    upload_end_time=$(date +%s)
    # è®¡ç®—ä¸Šä¼ æ—¶é—´(ç§’ï¼šs)
    upload_time=$[$upload_end_time - $upload_start_time]
    #è°ƒç”¨æ—¶é—´è½¬æ¢å‡½æ•°
    timeTransformation $upload_time "ä¸Šä¼ è’²å…¬è‹±"
}
########################## ä¸Šä¼ è‹¹æœå•†åº— #################################
uploadAppStore()
{
    # åˆ¤æ–­é…ç½®æ˜¯å¦ä¸ºç©ºï¼Œç©ºåˆ™ä»£è¡¨ä¸ä¸Šä¼ 
    if [ -z "$apple_id" ] || [ -z "$apple_pwd" ]; then
    echo "============ è¯·å…ˆé…ç½®è‹¹æœå•†åº—çš„ apple_id & apple_pwd ======="
    return
    fi
    # ä¸Šä¼ å¼€å§‹æ—¶é—´
    upload_start_time=$(date +%s)
    # å¼€å§‹ä¸Šä¼ 
    echo "============ å‡†å¤‡ä¸Šä¼  ${d_filename} åˆ° AppStore ======="
    altoolPath="/Applications/Xcode.app/Contents/Applications/Application Loader.app/Contents/Frameworks/ITunesSoftwareService.framework/Versions/A/Support/altool"
    # validateï¼ˆéªŒè¯ï¼‰
    echo "============ ${d_filename} æ­£åœ¨éªŒè¯IPAåŒ… ======="
    "$altoolPath" --validate-app -f "$ipa_path" -u "$apple_id" -p "$apple_pwd" -t ios --output-format xml
    judgementLastIsSuccsess $? "éªŒè¯IPAåŒ…"
    # ä¸Šä¼ 
    echo "============ ${d_filename} éªŒè¯ç»“æŸï¼Œæ­£åœ¨ä¸Šä¼ ä¸­ ======="
    "$altoolPath" --upload-app -f "$ipa_path" -u "$apple_id" -p "$apple_pwd" -t ios --output-format xml
    judgementLastIsSuccsess $? "ä¸Šä¼ App Store"
    echo "============ ${d_filename} AppStore - ä¸Šä¼ ç»“æŸ ======="
    # ä¸Šä¼ ç»“æŸæ—¶é—´
    upload_end_time=$(date +%s)
    # è®¡ç®—ä¸Šä¼ æ—¶é—´(ç§’ï¼šs)
    upload_time=$[$upload_end_time - $upload_start_time]
    #è°ƒç”¨æ—¶é—´è½¬æ¢å‡½æ•°
    timeTransformation $upload_time "ä¸Šä¼ App Store"
}

if [ $packaging -eq 2 ]; then
uploadAppStore
else
uploadPGY
exit
fi
```