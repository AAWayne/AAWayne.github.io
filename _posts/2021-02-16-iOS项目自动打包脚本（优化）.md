---
layout:     post
title:      iOS项目自动打包脚本
subtitle:   
date:       2021-02-16
author:     阿唯不知道
header-img: img/post-bg-map.jpg
catalog: true
tags:
    - iOS
    - shell脚本
---

## 前言

平时自用打包脚本，支持自动上传蒲公英、App Store

## 正文 

### 自动功能打包展示：
![打包演示.png](https://upload-images.jianshu.io/upload_images/2822163-90ac29e69da07fc8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

##### Github地址：https://github.com/90candy/AutoPackage
#### 使用方法：[点击下载脚本相关文件](https://codeload.github.com/90candy/AutoPackage/zip/master)

1、将`AutoPackage.sh` 脚本和`autoplist文件夹`拖入`项目根目录`后

2、配置打开编辑`AutoPackage.sh`中的配置参数（若只打包，则只需配置`pro_full_name`即可）

3、再将`AutoPackage.sh`脚本文件拖入`终端`回车即可执行自动打包脚本

4、执行后按需求选择打包版本（企业版、正式版、测试版、开发版）

5、如果执行脚本时出现如下错误是因为文件权限不足，只需对其授权777即可

```
-bash: /Users/candy/Desktop/AutoPackage.sh: Permission denied
```
执行如下授权命令即可（这里的`/Users/candy/Desktop/AutoPackage.sh`路径参考上面的）

```
chmod -R 777 /Users/candy/Desktop/AutoPackage.sh
```
6、如果需要上传 App Store，则安装 Transporter 上传工具，并且使用专用密码

### 打包脚本核心内容展示

```
############################ 参数配置 ###################################
# ⚠️默认 Release 版，也可配置为 Debug
pro_environ=Release
# 项目路径(文件绝对路径，如"/Users/xxx/BaseProject/BaseProject.xcworkspace")
pro_path="/Users/xxx/BaseProject/BaseProject.xcworkspace"


# 打包开始时间（用于计算打包脚本执行时间）
begin_time=$(date +%s)
# 获取系统时间
date_string=`date +"%Y-%m-%d~%H.%M.%S"`

# 获取脚本当前所在目录(即上级目录绝对路径)
root_dir=$(cd "$(dirname "$0")"; pwd)
# IPA 文件导出时使用的 plist 文件路径
plist_path="${root_dir}/ExportOptions/${plist_name}"

# 切换到当前脚本的工作目录
cd ${root_dir}

# 所有打包文件导出时的临时存放目录（IPA、Achieve）
temp_path="${root_dir}/ExportIPAFile"
if [ ! -d ${temp_path} ]; then
   mkdir -p ${temp_path}
fi

# 切换到 temp_path 目录去创建存放 Archive 和 IPA 的文件夹
cd ${temp_path}
ipa_dir="${pro_name}${date_string}"
mkdir ${ipa_dir}

# 切换到项目根目录开始打包操作
cd "${pro_path}"

echo "============ ${pro_name} 打包开始 ======="

# 如果没有使用cocoapods 反之if会处理
pro_clean=project
if [ ${pro_suffix} == "xcworkspace" ]; then
pro_clean=workspace
fi

# 先组装 archive_path、ipa_path，用于导出 ipa 和 上传
archive_path="${temp_path}/${ipa_dir}/${pro_name}.xcarchive"
ipa_path="${temp_path}/${ipa_dir}/${pro_name}.ipa"

# Clean操作
xcodebuild clean -${pro_clean} ${pro_full_name} -scheme ${pro_name} -configuration ${pro_environ}
judgementLastIsSuccsess $? "Clean"

# Archive操作
xcodebuild archive -${pro_clean} ${pro_full_name} -scheme ${pro_name} -archivePath ${archive_path}
judgementLastIsSuccsess $? "Archive"

# 导出IPA文件操作
xcodebuild -exportArchive -archivePath ${archive_path} -exportOptionsPlist ${plist_path} -exportPath ${temp_path}/${ipa_dir}
judgementLastIsSuccsess $? "导出IPA文件"

# 删除 xcarchive 包
rm -r ${archive_path}

# 打包结束时间
end_time=$(date +%s)
# 计算打包时间(秒：s)
cost_time=$[${end_time} - ${begin_time}]
# 调用时间转换函数
timeTransformation ${cost_time} "打包"

echo "============ ${pro_name} 自动打包完成 ======="

# 打开 当前的 ipa 存放文件夹
open ${temp_path}/${ipa_dir}

########################## 上传蒲公英 #################################
uploadPGY()
{
    # 判断配置是否为空，空则代表不上传
    if [ -z "${api_key}" ] || [ -z "${ukey}" ]; then
    echo "============ 请先配置蒲公英的 api_key & ukey ======="
    return
    fi
    # 上传开始时间
    upload_start_time=$(date +%s)
    # 开始上传
    echo "============ 正在上传 ${pro_name} 到 蒲公英 ======="
    curl -F "file=@${ipa_path}" -F "uKey=${ukey}" -F "_api_key=${api_key}" -F "installType=${pgy_installType}" -F "password=${pgy_password}" https://qiniu-storage.pgyer.com/apiv1/app/upload
    judgementLastIsSuccsess $? "上传蒲公英"
    echo "============ 上传结束 ======="
    # 上传结束时间
    upload_end_time=$(date +%s)
    # 计算上传时间(秒：s)
    upload_time=$[${upload_end_time} - ${upload_start_time}]
    # 调用时间转换函数
    timeTransformation ${upload_time} "上传蒲公英"
}

########################## 上传苹果商店 #################################
uploadAppStore()
{
    # 判断配置是否为空，空则代表不上传
    if [ -z "${apple_id}" ] || [ -z "${apple_pwd}" ]; then
    echo "============ 请先配置苹果商店的 apple_id & apple_pwd ======="
    return
    fi
    # 上传开始时间
    upload_start_time=$(date +%s)
    echo "============ AppStore 上传开始 ======="
    # 如果是命令安装的 Transporter，则路径为：/Applications/Xcode.app/Contents/SharedFrameworks/ContentDeliveryServices.framework/itms/bin/iTMSTransporter
    # 开始上传 - 这里用的是从 App Store 下载的 Transporter 上传工具【推荐】
    toolPath="/Applications/Transporter.app/Contents/itms/bin/iTMSTransporter"
    ${toolPath} -m upload -assetFile ${ipa_path} -u ${apple_id} -p ${apple_pwd} -v informational
    judgementLastIsSuccsess $? "上传App Store"
    echo "============ AppStore 上传结束 ======="
    # 上传结束时间
    upload_end_time=$(date +%s)
    # 计算上传时间(秒：s)
    upload_time=$[${upload_end_time} - ${upload_start_time}]
    # 调用时间转换函数
    timeTransformation ${upload_time} "上传App Store"
}

if [ "${plist_name}"x = "AppStoreExportOptions.plist"x ]; then
uploadAppStore
else
uploadPGY
fi
```
![](http://upload-images.jianshu.io/upload_images/2822163-089602958ae7072a.png)